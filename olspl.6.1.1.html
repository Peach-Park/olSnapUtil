<!doctype html>
<html lang="ko">

<head>
  <link rel="stylesheet" href="http://localhost:8081/outerlib/ol_6.1.1.css" type="text/css">
  <style>
    body {
      padding: 0px;
      margin: 0px;
    }

    .map {
      margin: 0px;
      height: 100vh;
      width: 100vw;
    }
  </style>
  <script src="http://localhost:8081/outerlib/ol_6.1.1.js"></script>
  <script src="http://localhost:8081/outerlib/snapUtil.min.js"></script>
  <script src="http://localhost:8081/outerlib/iclient-openlayers.js"></script>
  <title>OpenLayers example</title>
</head>

<body>
  <div id="map" class="map"></div>
</body>
<script type="text/javascript">
  var map = new ol.Map({
    target: 'map',
    layers: [
      new ol.layer.Tile({
        source: new ol.source.OSM()
      })
    ],
    view: new ol.View({
      center: [14137183.577959234, 4425166.288674235],
      zoom: 17
    })
  });


  //snap test
  let pipeCoord = JSON.parse("[[14135804.132962223,4424858.518790312],[14135815.266753737,4424863.426079205],[14135834.739303816,4424870.449032937],[14135857.914508764,4424879.811383209],[14135877.836496927,4424887.567623879],[14135881.2746692,4424888.730941133],[14135892.183735667,4424891.9349937],[14135905.492080111,4424894.893565705],[14135930.08571488,4424899.359083359],[14135951.19873204,4424902.587238433],[14135954.820679663,4424902.653019304],[14135979.55737002,4424902.862490844],[14135980.93123232,4424902.753570959],[14136004.292112581,4424899.342769729],[14136018.805221463,4424897.260213028],[14136025.156229354,4424896.601366344],[14136029.405157665,4424896.603242505],[14136040.13247717,4424896.003979225],[14136054.413300252,4424893.7081039855],[14136070.42480107,4424893.966278013],[14136079.545799304,4424894.557108268],[14136100.310420634,4424906.634241115],[14136121.724426674,4424919.575673478],[14136142.82624321,4424932.538359519],[14136147.424604848,4424934.693933302],[14136166.69148497,4424940.324731605],[14136190.82428644,4424946.1982232295],[14136205.620368985,4424948.529457487],[14136215.568185387,4424949.474004215],[14136220.569001762,4424949.5135304155],[14136241.534099711,4424948.586729299],[14136266.460968377,4424946.9642194165],[14136289.981491236,4424945.456879415],[14136314.927042533,4424944.147842769],[14136339.868848553,4424942.772267056],[14136366.04215688,4424941.055593496],[14136392.138015598,4424939.392783331],[14136402.027401082,4424937.9551589815],[14136416.662966453,4424935.099390389],[14136439.938200878,4424926.046853567],[14136458.926700229,4424919.768412477],[14136463.779009156,4424918.550963294],[14136473.459900321,4424916.0508307405],[14136488.333898285,4424913.863554339],[14136497.39885542,4424913.251112043],[14136503.523667581,4424913.740925184],[14136513.39516891,4424915.920701489],[14136518.263485411,4424916.932183634],[14136532.51483488,4424921.520704801],[14136537.009602034,4424923.731287614],[14136558.69025284,4424936.1137017505],[14136572.658162871,4424940.378530448],[14136582.55848358,4424941.971219854],[14136587.539282724,4424942.354259441],[14136600.135050945,4424941.792230161],[14136605.124665756,4424941.378757273],[14136629.809362318,4424937.530174002],[14136644.743316786,4424935.2423316315],[14136654.702550355,4424934.447952975],[14136674.705810867,4424934.412044922],[14136679.665357767,4424935.030854554],[14136704.498111477,4424937.6369337],[14136725.036398908,4424963.066576613],[14136726.657648243,4424961.786024663],[14136728.201203454,4424963.759226834],[14136742.356524363,4424984.493375752],[14136757.200120503,4425004.684467145],[14136772.094983518,4425024.834185991],[14136787.228469403,4425044.797041138],[14136802.372004313,4425064.751131933],[14136817.418170512,4425084.783001094],[14136832.856592791,4425104.505087368],[14136839.96012009,4425113.789087839],[14136849.053241827,4425123.6289097145],[14136861.728534121,4425132.19705315],[14136879.873400936,4425136.530824736],[14136898.533400716,4425132.368810884],[14136923.026157029,4425127.438204191],[14136948.619116966,4425124.587336789],[14136973.959543847,4425125.747836469],[14136998.812799374,4425128.310623782],[14137023.557339553,4425132.154049907],[14137047.17148129,4425137.835002482],[14137071.64872544,4425142.823538613],[14137096.284650577,4425146.972859058],[14137120.480949268,4425151.231234402],[14137145.46791177,4425154.501149865],[14137170.085139109,4425159.144521537],[14137183.721266074,4425165.873445353],[14137203.936791249,4425180.039724414],[14137204.342727382,4425179.564333825],[14137212.746874783,4425187.257656518],[14137231.71092591,4425203.573856098],[14137250.992289182,4425219.52252545],[14137270.178783609,4425235.585328487],[14137275.058463557,4425239.975773942],[14137282.85688947,4425249.831608314],[14137286.256502904,4425255.057427168],[14137296.848612444,4425277.7782315165],[14137306.763802787,4425300.8038705075],[14137316.316822082,4425323.985084111],[14137325.681281598,4425347.245360886],[14137335.855145406,4425370.159486771],[14137327.29810446,4425374.59982583],[14137328.41840339,4425377.175113038],[14137318.001533933,4425383.621173453],[14137327.04765323,4425402.528828051],[14137347.09315356,4425395.6188346995],[14137348.573158214,4425398.939241306]]");
  let markerSource = new ol.source.Vector();
  let markerLayer = new ol.layer.Vector({
    source: markerSource
  });

  let pipeFeature = new ol.Feature();
  pipeFeature.setGeometry(new ol.geom.LineString(pipeCoord));

  markerLayer.set('layerId', 'markerLayer');
  map.addLayer(markerLayer);

  markerSource.addFeature(pipeFeature);

  //test
  map.on('click', ({ pixel, coordinate, ...e }) => {
    markerSource.clear();

    let clickedPoint = new ol.Feature(new ol.geom.Point(coordinate));

    let featGeom = pipeFeature.getGeometry();
    // featGeom.transform("EPSG:5186", "EPSG:3857");   //JB

    //debug ---------------->
    let lineCoords = featGeom.getCoordinates();
    let f1 = new ol.Feature();
    f1.setGeometry(featGeom);
    markerSource.addFeature(f1);
    lineCoords.forEach((coord, i) => {
      let fill = new ol.style.Fill({
        color: '#ff0000',
      });
      let feat = new ol.Feature();
      feat.setGeometry(new ol.geom.Point(coord));
      feat.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
          fill,
          radius: 3
        }),
      }))
      markerSource.addFeature(feat);
    });
    //debug <----------------

    let snapped = snt(pixel, coordinate, pipeFeature, map, markerLayer);
    console.log(snapped);
  });


</script>

</html>